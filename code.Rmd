---
title: "Project work"
author: "Anonymous"
date: "11/14/2020"
output:
  pdf_document:
    toc: yes
    toc_depth: 2
  html_document:
    toc: yes
    toc_depth: '1'
    df_print: paged
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loaded packages

```{r, message=FALSE, warning=FALSE}
library(rstan) 
rstan_options(auto_write = TRUE)
options(mc.cores = 3)
library(ggplot2)
library(aaltobda)
library(shinystan)
library(bayesplot)
library(loo)
library(dlookr)
library(corrplot)
library(rstanarm)
library(projpred)
library(GGally)
SEED <- 48927
```

# Data
## Breast cancer dataset
```{r}
cancer_data = read.csv('cancer.csv')
cancer_data[cancer_data == "B"] <- as.numeric(0)
cancer_data[cancer_data == "M"] <- as.numeric(1)
cancer_data$diagnosis <- as.numeric(as.character(cancer_data$diagnosis))
corrplot(cor(cancer_data[,2:32]))
describe(cancer_data[,2:32])
head(cancer_data[,2:32])
print(nrow(cancer_data))
```

# Preprocessing
## Feature selection
For this task, we reduce the number of input variables in order to develop our models. As seen in the correlation map, variables such as **radius_mean**, **perimeter_mean** and **area_mean** are highly correlated. Thus, we discard the variables **radius_mean**, **perimeter_mean**. Etc...
```{r}
cancer_data$radius_mean <- NULL
cancer_data$perimeter_mean <- NULL
cancer_data$compactness_mean <- NULL
cancer_data$concave.points_mean <- NULL
cancer_data$radius_se <- NULL
cancer_data$perimeter_se <- NULL
cancer_data$compactness_se <- NULL
cancer_data$concave.points_se <- NULL
cancer_data$radius_worst <- NULL
cancer_data$perimeter_worst <- NULL
cancer_data$compactness_worst <- NULL
cancer_data$concave.points_worst <- NULL
cancer_data$X <- NULL

cancer_data_mv <- cancer_data
cancer_data$area_worst <- NULL
cancer_data$texture_worst <- NULL
```

### Selected variables
```{r}
head(cancer_data)
corrplot(cor(cancer_data))
corrplot(cor(cancer_data_mv))
#hist(cancer_data$texture_mean)
#hist(cancer_data$area_mean)
#hist(cancer_data$smoothness_mean)
#hist(cancer_data$symmetry_mean)
#hist(cancer_data$texture_se)
```

## Scaling
```{r}
scaled_cancer_data <- cancer_data
col_names <- colnames(cancer_data)
scaled_cancer_data_mv <- cancer_data_mv
col_names_mv <- colnames(cancer_data_mv)

scaled_cancer_data[,1:2] <- cancer_data[,1:2]
scaled_cancer_data[,3:18] <- scale(cancer_data[,3:18])
colnames(scaled_cancer_data) <- col_names
head(scaled_cancer_data)

scaled_cancer_data_mv[,1:2] <- cancer_data_mv[,1:2]
scaled_cancer_data_mv[,3:20] <- scale(cancer_data_mv[,3:20])
colnames(scaled_cancer_data_mv) <- col_names_mv
head(scaled_cancer_data_mv)
```

# Linear Model
```{r}
linear_model_normal <- rstan::stan_model(file = "models/linear_model_normal.stan")
linear_model_bernoulli <- rstan::stan_model(file = "models/linear_model_bernoulli.stan")
linear_model <- linear_model_bernoulli
```

# Linear Model - texture_mean
```{r}
linear_data_1 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$texture_mean))
linear_sampling_1 <- rstan::sampling(linear_model, data = linear_data_1, refresh=0)
```

# Linear Model - area_mean
```{r}
linear_data_2 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$area_mean))
linear_sampling_2 <- rstan::sampling(linear_model, data = linear_data_2, refresh=0)
```

# Linear Model - smoothness_mean
```{r}
linear_data_3 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$smoothness_mean))
linear_sampling_3 <- rstan::sampling(linear_model, data = linear_data_3, refresh=0)
```

# Linear Model - concavity_mean
```{r}
linear_data_4 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$concavity_mean))
linear_sampling_4 <- rstan::sampling(linear_model, data = linear_data_4, refresh=0)
```

# Linear Model - symmetry_mean
```{r}
linear_data_5 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$symmetry_mean))
linear_sampling_5 <- rstan::sampling(linear_model, data = linear_data_5, refresh=0)
```

# Linear Model - fractal_dimension_mean
```{r}
linear_data_6 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$fractal_dimension_mean))
linear_sampling_6 <- rstan::sampling(linear_model, data = linear_data_6, refresh=0)
```

# Linear Model - texture_se
```{r}
linear_data_7 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$texture_se))
linear_sampling_7 <- rstan::sampling(linear_model, data = linear_data_7, refresh=0)
```

# Linear Model - area_se
```{r}
linear_data_8 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$area_se))
linear_sampling_8 <- rstan::sampling(linear_model, data = linear_data_8, refresh=0)
```

# Linear Model - smoothness_se
```{r}
linear_data_9 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$smoothness_se))
linear_sampling_9 <- rstan::sampling(linear_model, data = linear_data_9, refresh=0)
```

# Linear Model - concavity_se
```{r}
linear_data_10 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$concavity_se))
linear_sampling_10 <- rstan::sampling(linear_model, data = linear_data_10, refresh=0)
```

# Linear Model - symmetry_se
```{r}
linear_data_11 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$symmetry_se))
linear_sampling_11 <- rstan::sampling(linear_model, data = linear_data_11, refresh=0)
```

# Linear Model - fractal_dimension_se
```{r}
linear_data_12 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$fractal_dimension_se))
linear_sampling_12 <- rstan::sampling(linear_model, data = linear_data_12, refresh=0)
```

# Linear Model - fractal_dimension_se
```{r}
linear_data_13 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$fractal_dimension_se))
linear_sampling_13 <- rstan::sampling(linear_model, data = linear_data_13, refresh=0)
```

# Linear Model - fractal_dimension_se
```{r}
linear_data_14 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$fractal_dimension_se))
linear_sampling_14 <- rstan::sampling(linear_model, data = linear_data_14, refresh=0)
```

# Linear Model - fractal_dimension_se
```{r}
linear_data_15 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$fractal_dimension_se))
linear_sampling_15 <- rstan::sampling(linear_model, data = linear_data_15, refresh=0)
```

# Linear Model - fractal_dimension_se
```{r}
linear_data_16 <- list(N=length(scaled_cancer_data$diagnosis), y=c(scaled_cancer_data$diagnosis), x=c(scaled_cancer_data$fractal_dimension_se))
linear_sampling_16 <- rstan::sampling(linear_model, data = linear_data_16, refresh=0)
```

# Plot the model
```{r}
plot(scaled_cancer_data$texture_mean, scaled_cancer_data$diagnosis)
params = extract(linear_sampling_1)
alpha = mean(params$alpha)
beta = mean(params$beta)
abline(a=alpha, b=beta)
```

# Plot simulated data
```{r}
par(mfrow=c(2,2))
params=extract(linear_sampling_1)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_2)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_3)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_4)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_5)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_6)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_7)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_8)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_9)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_10)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_11)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_12)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_13)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_14)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_15)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])

params=extract(linear_sampling_16)
ppc_dens_overlay(scaled_cancer_data$diagnosis, params$y_sim[1:100,])
```


```{r}
monitor(linear_sampling_1)
model_log_lik <- extract_log_lik(linear_sampling_1, parameter_name = "log_lik", merge_chains = FALSE)
model_r_eff <- relative_eff(exp(model_log_lik), cores = 2)
model_loo <- loo(model_log_lik, r_eff = model_r_eff, cores = 2)
pooled_k_values <- model_loo$diagnostics$pareto_k
```

```{r}
print(model_loo)
hist(pooled_k_values)
```


# Convergence diagnostics
## $\hat{R}
$\hat{R}$ can be used to monitor if a group of chains has converged to the target distribution. This can be done by comparing the between and within-chain estimate for model parameters. If chains have not converged, meaning that they have not mixed well, $\hat{R}$ will be greater than one. If chains have converged, the $\hat{R}$ value will be virtually one.

As seen in the `monitor` outputs, all $\hat{R}$ values were 1 or close to 1. (Por concluir)

## ESS
We would like to have a diagnostic that tell us when the weights are problematic, as we could have vastly imbalanced weights. In this case, we could use **effective sample size ($S_{eff}$)**, a quantitative measure of efficiency in **importance sampling**. $S_{eff}$ represents the number of independent samples required to obtain an importance sampling estimate with about the same efficiency as if we would have used all the samples.

`monitor` function gives us two crude measures of effective sample size called Bulk_ESS and Tail_ESS (an $ESS > 100$ per chain is considered good). As seen in the `monitor` outputs, our ESS values are way higher than 100, which established that our values are good. (Aún no está claro que esto sea válido, preguntar a TA)

## Divergences

A divergence arises when the simulated Hamiltonian trajectory departs from the true trajectory as measured by departure of the Hamiltonian value from its initial value [...]. Habrá que indicar si hemos obtenido divergencias o no en los modelos más adelante con la siguiente función:

```{r}
check_hmc_diagnostics(linear_sampling_1)
```

As seen in the obtained results, we obtained 0 divergences... etc

# Model comparison

# Sensitivity analysis







# Multivariate Model
```{r}
linear_model_bernoulli_multivariate <- rstan::stan_model(file = "models/linear_model_bernoulli_multivariate.stan")
```

# Multivariate Model - w/ Mean Variables
```{r}
multivariate_mean_data <- list(N=length(scaled_cancer_data_mv$diagnosis), 
                               y=c(scaled_cancer_data_mv$diagnosis), 
                               x_1=c(scaled_cancer_data_mv$texture_mean),
                               x_2=c(scaled_cancer_data_mv$area_mean),
                               x_3=c(scaled_cancer_data_mv$smoothness_mean),
                               x_4=c(scaled_cancer_data_mv$concavity_mean),
                               x_5=c(scaled_cancer_data_mv$symmetry_mean),
                               x_6=c(scaled_cancer_data_mv$fractal_dimension_mean))
multivariate_mean_sampling <- rstan::sampling(linear_model_bernoulli_multivariate,
                                              data = multivariate_mean_data, refresh=0)
```

# Multivariate Model - w/ SE Variables
```{r}
multivariate_se_data <- list(N=length(scaled_cancer_data_mv$diagnosis), 
                               y=c(scaled_cancer_data_mv$diagnosis), 
                               x_1=c(scaled_cancer_data_mv$texture_se),
                               x_2=c(scaled_cancer_data_mv$area_se),
                               x_3=c(scaled_cancer_data_mv$smoothness_se),
                               x_4=c(scaled_cancer_data_mv$concavity_se),
                               x_5=c(scaled_cancer_data_mv$symmetry_se),
                               x_6=c(scaled_cancer_data_mv$fractal_dimension_se))
multivariate_se_sampling <- rstan::sampling(linear_model_bernoulli_multivariate,
                                              data = multivariate_se_data, refresh=0)
```

# Multivariate Model - w/ Worst Variables
```{r}
multivariate_worst_data <- list(N=length(scaled_cancer_data_mv$diagnosis), 
                               y=c(scaled_cancer_data_mv$diagnosis), 
                               x_1=c(scaled_cancer_data_mv$texture_worst),
                               x_2=c(scaled_cancer_data_mv$area_worst),
                               x_3=c(scaled_cancer_data_mv$smoothness_worst),
                               x_4=c(scaled_cancer_data_mv$concavity_worst),
                               x_5=c(scaled_cancer_data_mv$symmetry_worst),
                               x_6=c(scaled_cancer_data_mv$fractal_dimension_worst))
multivariate_worst_sampling <- rstan::sampling(linear_model_bernoulli_multivariate,
                                               data = multivariate_worst_data, refresh=0)
```

# Plot simulated data
```{r}
params=extract(multivariate_mean_sampling)
ppc_dens_overlay(scaled_cancer_data_mv$diagnosis, params$y_sim[1:220,])

params=extract(multivariate_se_sampling)
ppc_dens_overlay(scaled_cancer_data_mv$diagnosis, params$y_sim[1:220,])

params=extract(multivariate_worst_sampling)
ppc_dens_overlay(scaled_cancer_data_mv$diagnosis, params$y_sim[1:220,])
```


```{r}
beta <- student_t(df = 1, location = 0, scale = 2)
alpha <- normal(0, 10)

post1 <- stan_glm(diagnosis ~ texture_mean + area_mean + smoothness_mean + concavity_mean
                  + symmetry_mean + fractal_dimension_mean
                  + texture_se + area_se + smoothness_se + concavity_se
                  + symmetry_se + fractal_dimension_se
                  + texture_worst + area_worst + smoothness_worst + concavity_worst
                  + symmetry_worst + fractal_dimension_worst,
                  data = scaled_cancer_data_mv,
                  family = binomial(link = "logit"), 
                  prior = beta, prior_intercept = alpha, QR=TRUE,
                  seed = SEED, refresh=0)
```



```{r}
preds <- posterior_epred(post1)
pred <- colMeans(preds)
pr <- as.integer(pred >= 0.5)
round(mean(xor(pr,as.integer(scaled_cancer_data_mv$diagnosis==0))), 4)

yrep <- posterior_predict(post1, draws = 50)
ppc_dens_overlay(scaled_cancer_data_mv$diagnosis, yrep)

mcmc_areas(as.matrix(post1))
```

# EJECUTAR UNA UNICA VEZ PARA CANTIDAD DE VARIABLES POR USAR
```{r}
refmodel <- get_refmodel(post1)
vs <- cv_varsel(refmodel, method = "forward")
solution_terms(vs)
plot(vs, stats = c('elpd', 'rmse'))
```


```{r}
post2 <- stan_glm(diagnosis ~ area_worst + smoothness_worst + concavity_mean,
                  data = scaled_cancer_data_mv,
                  family = binomial(link = "logit"), 
                  prior = beta, prior_intercept = alpha,
                  seed = SEED, refresh=0)

preds <- posterior_epred(post2)
pred <- colMeans(preds)
pr <- as.integer(pred >= 0.5)
round(mean(xor(pr, as.integer(scaled_cancer_data_mv$diagnosis==0))), 4)

yrep <- posterior_predict(post2, draws = 50)
ppc_dens_overlay(scaled_cancer_data_mv$diagnosis, yrep)

mcmc_areas(as.matrix(post2))
```


# Model Comparison
## Full multivariate model
```{r}
loo1 <- loo(post1, save_psis = TRUE)
loo1
```
## Multivariate model with 1 or more variables
```{r}
loo2 <- loo(post2, save_psis = TRUE)
loo2
```
## Model comparison
```{r}
loo_compare(loo1, loo2)
```


















